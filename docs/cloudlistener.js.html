<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: cloudlistener.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: cloudlistener.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 *  TCP Server Wrapper
 *  @module classes/cloudlistener
 */

// Core modules
var config = require('./config.js');
var log = require('./log.js');
var datamanager = require('./database/datamanager.js');
var net = require('net');
var msgpack = require('msgpack-js');
//var crypto = require('crypto');

var events = {
    "auth": function(socket, data) {
        log.debug("Auth " + data.apikey);

        var successful = data.apikey == "asdf"; // DEBUG
        //var successful = false;
        /*datamanager.getDaemons().forEach(function(d) {
            if(d.apikey === data.apikey) {
                socket.write(msgpack.encode({
                    'event': 'welcome'
                }));
                successful = true;
            }
        });*/
        if(!successful) {
            socket.write(msgpack.encode({
                'event': 'failed'
            }));
            socket.close();
        } else {                            // DEBUG
            socket.write(msgpack.encode({
                'event': 'welcome'
            }));
        }
    }
};

var server = net.createServer({allowHalfOpen: false}, function(con){
    log.debug('client connected!');
    con.on('data', function(msg){
        try {
            msg = msgpack.decode(msg);
        } catch(e) {
            log.debug('error decoding message: '+msg);
        }
        log.debug(JSON.stringify(msg));
        events[msg.event](con, msg);
    });
    con.on('end', function() {
        log.debug('client disconnected');
    });
    con.on('error', function(err) {
        log.warn(err);
    });
});

/**
 * Starts the TCP Server
 * @param cb callback
 */
exports.startServer = function(cb) {
    server.listen({port: config.getCloudSystemPort(), host: config.getListenIP()}, function() {
        if(cb){cb(config.getCloudSystemPort());}
    });
};

/**
 * Stops the TCP Server
 * @param cb callback
 */
exports.stopServer = function(cb) {
    server.close(function() {
        if(cb){cb();}
    });
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-classes_cloudlistener.html">classes/cloudlistener</a></li><li><a href="module-classes_config.html">classes/config</a></li><li><a href="module-classes_database_daemon.html">classes/database/daemon</a></li><li><a href="module-classes_database_plugin.html">classes/database/plugin</a></li><li><a href="module-classes_database_servertype.html">classes/database/servertype</a></li><li><a href="module-classes_database_user.html">classes/database/user</a></li><li><a href="module-classes_database_world.html">classes/database/world</a></li><li><a href="module-classes_loader.html">classes/loader</a></li><li><a href="module-classes_log.html">classes/log</a></li><li><a href="module-classes_mysql.html">classes/mysql</a></li><li><a href="module-classes_webserver.html">classes/webserver</a></li></ul><h3>Classes</h3><ul><li><a href="module-classes_database_daemon-Daemon.html">Daemon</a></li><li><a href="module-classes_database_plugin-Plugin.html">Plugin</a></li><li><a href="module-classes_database_servertype-Servertype.html">Servertype</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Wed Nov 18 2015 17:51:49 GMT+0100 (Mitteleurop√§ische Zeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
